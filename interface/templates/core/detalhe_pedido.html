{% extends 'core/base.html' %}

{% block title %}Detalhe do Pedido {{ pedido.codigo }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Pedido {{ pedido.codigo }}</h3>
    {% if user.papel == 'admin' %}
      <a href="{% url 'deletar_pedido' pedido.id %}"
         class="btn btn-outline-danger"
         onclick="return confirm('Excluir pedido {{ pedido.codigo }}?');">
        <i class="bi bi-trash"></i> Deletar
      </a>
    {% endif %}
  </div>

  <p><strong>Status:</strong> {{ pedido.get_status_display }}</p>

  <form method="post">
    {% csrf_token %}
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Produto</th>
          <th>Quantidade Solicitada</th>
          <th>Quantidade Liberada</th>
        </tr>
      </thead>
      <tbody>
        {% for item in pedido.itens.all %}
          <tr>
            <td>{{ item.produto.descricao }}</td>
            <td>{{ item.quantidade }}</td>
            <td>
              {% if eh_admin_tecnico and pedido.status in 'aguardando_aprovacao aprovado' %}
                <input type="number"
                       name="liberado_{{ item.id }}"
                       value="{{ item.liberado|default:item.quantidade }}"
                       min="0"
                       max="{{ item.quantidade }}"
                       class="form-control form-control-sm"
                       required>
              {% else %}
                {{ item.liberado|default:"–" }}
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if eh_admin_tecnico and pedido.status == 'aguardando_aprovacao' %}
      <div class="d-flex gap-2 mb-3">
        <button type="submit" name="action" value="aprovar" class="btn btn-success">
          Confirmar Aprovação
        </button>
        <button type="button" class="btn btn-danger" data-bs-toggle="collapse" data-bs-target="#reprovaMotivo">
          Reprovar
        </button>
        <a href="{% url 'lista_pedidos' %}" class="btn btn-secondary">Voltar</a>
      </div>
      <div class="collapse" id="reprovaMotivo">
        <div class="card card-body mb-3">
          <label for="motivo_reprovacao" class="form-label fw-bold">Motivo da Reprovação:</label>
          <select name="motivo_reprovacao" id="motivo_reprovacao" class="form-select mb-2" required>
            <option value="">Selecione...</option>
            <option>Estoque insuficiente</option>
            <option>Produto vencido</option>
            <option>Pedido em duplicidade</option>
            <option>Produto em recall</option>
            <option>Produto não faz parte do contrato</option>
            <option>Pedido fora do período permitido</option>
            <option>Erro de cadastro ou informação</option>
            <option>Outro (especificar)</option>
          </select>
          <input type="text" name="motivo_reprovacao_extra" class="form-control" placeholder="Se outro, detalhe aqui...">
          <button type="submit" name="action" value="reprovar" class="btn btn-danger mt-2">
            Confirmar Reprovação
          </button>
        </div>
      </div>
    {% elif eh_admin_tecnico and pedido.status == 'aprovado' %}
      <div class="d-flex gap-2 mb-3">
        <button type="submit" name="action" value="separar" class="btn btn-warning">
          Confirmar Liberação
        </button>
        <a href="{% url 'lista_pedidos' %}" class="btn btn-secondary">Voltar</a>
      </div>
    {% endif %}
  </form>

  {% if pedido.status == 'separado' or pedido.status == 'entregue' %}
    <div class="mt-4">
      <h5>Resultado da Liberação</h5>
      <ul>
        {% for item in pedido.itens.all %}
          <li>
            {{ item.produto.descricao }}:
            solicitado {{ item.quantidade }},
            liberado {{ item.liberado|default:"0" }}
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
</div>
{% endblock %}
