{# interface/templates/core/confirmar_importacao.html #}
{% extends 'core/base.html' %}
{% block title %}Confirmar Importação de Produtos{% endblock %}

{% block content %}
<div class="container mt-5">
    <h3 class="mb-4">Produtos extraídos da Nota Fiscal</h3>

    {% if produtos %}
    <form method="post" action="{% url 'cadastro_produtos' %}">
        {% csrf_token %}

        {# ————————— Campos ocultos de cabeçalho da NFe ————————— #}
        <input type="hidden" name="nfe_numero" value="{{ nfe_numero }}">
        <input type="hidden" name="data_emissao" value="{{ data_emissao }}">
        <input type="hidden" name="cnpj_fornecedor" value="{{ cnpj_fornecedor }}">
        <input type="hidden" name="valor_total" value="{{ valor_total }}">
        <input type="hidden" name="peso" value="{{ peso }}">

        <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle">
                <thead class="table-light">
                    <tr>
                        <th class="text-center">NFe Nº</th>
                        <th>Código de Barras</th>
                        <th>Descrição</th>
                        <th>Fornecedor</th>
                        <th class="area-col text-center">Área <span class="text-danger">*</span></th>
                        <th class="text-center">Lote</th>
                        <th>Validade<span class="text-danger"> *</span></th>
                        <th class="text-center">Quantidade</th>
                        <th class="text-center">Preço Unitário</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for produto in produtos %}
                    <tr>
                        {# — Coluna “NFe Nº”: apenas para exibição (readonly), sem name — #}
                        <td class="text-center">
                            <input type="text"
                                   class="form-control form-control-sm text-center"
                                   value="{{ nfe_numero }}"
                                   readonly>
                        </td>

                        {# — Código de Barras — #}
                        <td>
                            <input type="text" name="codigo_barras"
                                   class="form-control form-control-sm"
                                   value="{{ produto.codigo_barras }}"
                                   readonly>
                        </td>

                        {# — Descrição — #}
                        <td>
                            <input type="text" name="descricao"
                                   class="form-control form-control-sm"
                                   value="{{ produto.descricao }}"
                                   readonly>
                        </td>

                        {# — Fornecedor — #}
                        <td>
                            <input type="text" name="fornecedor_nome"
                                   class="form-control form-control-sm"
                                   value="{{ produto.fornecedor_nome }}"
                                   readonly>
                        </td>

                        {# — Área (dropdown obrigatório) — #}
                        <td class="area-col text-center">
                            <select name="area_id" class="form-select form-select-sm" required>
                                <option value="">Selecione...</option>
                                {% for area in areas %}
                                    <option value="{{ area.id }}"
                                        {% if produto.area_id == area.id %}selected{% endif %}>
                                        {{ area.nome }}
                                    </option>
                                {% endfor %}
                            </select>
                        </td>

                        {# — Lote (em branco, readonly, para ser calculado no save()) — #}
                        <td class="text-center">
                            <input type="text" name="lote"
                                   class="form-control form-control-sm text-center"
                                   value="{{ produto.lote }}"
                                   readonly>
                        </td>

                        {# — Validade: agora marcada como required — #}
                        <td>
                            <input type="date" name="validade"
                                   class="form-control form-control-sm"
                                   value="{{ produto.validade|date:'Y-m-d' }}"
                                   required>
                        </td>

                        {# — Quantidade — #}
                        <td>
                            <input type="number" name="quantidade"
                                   class="form-control form-control-sm text-center"
                                   value="{{ produto.quantidade }}"
                                   readonly>
                        </td>

                        {# — Preço Unitário: exibe com vírgula, envia hidden com ponto — #}
                        <td>
                            {% with preco_str=produto.preco_unitario|floatformat:"2" %}
                                {# Exibição para o usuário: substitui ponto por vírgula via slice #}
                                <input type="text"
                                       class="form-control form-control-sm text-end"
                                       readonly
                                       value="{{ preco_str|slice:":-3" }},{{ preco_str|slice:"-2:" }}"
                                       data-preco-bruto="{{ preco_str }}">
                                {# Hidden real enviado (com ponto, por exemplo 74.34) #}
                                <input type="hidden" name="preco_unitario"
                                       value="{{ preco_str }}">
                            {% endwith %}
                        </td>

                        {# — Status — #}
                        <td class="text-center">
                            <input type="text" name="status"
                                   class="form-control form-control-sm text-center"
                                   value="{{ produto.status }}"
                                   readonly>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-end mt-4 gap-2">
            <a href="{% url 'upload_nfe' %}" class="btn btn-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary">Confirmar Importação</button>
        </div>
    </form>
    {% else %}
        <div class="alert alert-warning">Nenhum produto encontrado na NFe.</div>
    {% endif %}
</div>
{% endblock %}
