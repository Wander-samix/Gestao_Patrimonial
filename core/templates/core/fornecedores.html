{% extends 'core/base.html' %}
{% block title %}Lista de Fornecedores{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- TÃ­tulo e BotÃ£o para novo fornecedor -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <h2 class="mb-0">Fornecedores</h2>
    <button class="btn btn-success flex-shrink-0" onclick="adicionarLinhaFornecedor()">+ Fornecedor</button>
  </div>

  <!-- Tabela de fornecedores responsiva -->
  <div class="table-responsive">
    <table class="table table-bordered table-hover mb-0 text-center align-middle">
      <thead class="bg-primary text-white text-center align-middle">
        <tr>
          <th>#</th>
          <th>Nome</th>
          <th class="d-none d-sm-table-cell">CNPJ</th>
          <th class="d-none d-md-table-cell">Telefone</th>
          <th class="d-none d-lg-table-cell">Email</th>
          <th>Status</th>
          <th>AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody class="text-center align-middle">
        {% for f in fornecedores %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td class="text-start">{{ f.nome }}</td>
          <td class="d-none d-sm-table-cell">{{ f.cnpj|default:'â€“' }}</td>
          <td class="d-none d-md-table-cell">{{ f.telefone|default:'â€“' }}</td>
          <td class="d-none d-lg-table-cell">{{ f.email|default:'â€“' }}</td>
          <td>{% if f.ativo %}Ativo{% else %}Inativo{% endif %}</td>
          <td>
            <div class="d-flex flex-wrap justify-content-center gap-1">
              {% if not f.ativo %}
              <a href="{% url 'ativar_fornecedor' f.id %}" class="btn btn-sm btn-outline-success" title="Ativar">
                <i class="bi bi-check-circle"></i>
              </a>
              {% else %}
              <a href="{% url 'desativar_fornecedor' f.id %}" class="btn btn-sm btn-outline-warning" title="Desativar">
                <i class="bi bi-x-circle"></i>
              </a>
              {% endif %}
              <a href="{% url 'editar_fornecedor' f.id %}" class="btn btn-sm btn-outline-secondary" title="Editar">
                <i class="bi bi-pencil-square"></i>
              </a>
              <a href="{% url 'deletar_fornecedor' f.id %}" class="btn btn-sm btn-outline-danger" title="Excluir"
                 onclick="return confirm('Deseja excluir este fornecedor?')">
                <i class="bi bi-trash"></i>
              </a>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center">Nenhum fornecedor encontrado.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Script para inserÃ§Ã£o inline de fornecedores -->
<script>
function adicionarLinhaFornecedor() {
    const tbody = document.querySelector("table tbody");
    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td>-</td>
        <td><input type="text" class="form-control form-control-sm w-100 nome" placeholder="Nome"></td>
        <td class="d-none d-sm-table-cell"><input type="text" class="form-control form-control-sm w-100 cnpj" placeholder="CNPJ"></td>
        <td class="d-none d-md-table-cell"><input type="text" class="form-control form-control-sm w-100 telefone" placeholder="Telefone"></td>
        <td class="d-none d-lg-table-cell"><input type="email" class="form-control form-control-sm w-100 email" placeholder="Email"></td>
        <td>-</td>
        <td class="text-center flex-column flex-sm-row d-flex gap-1">
            <button class="btn btn-sm btn-outline-success w-100 w-sm-auto" onclick="salvarFornecedor(this)">ðŸ’¾</button>
            <button class="btn btn-sm btn-outline-danger w-100 w-sm-auto" onclick="this.closest('tr').remove()">ðŸ—‘</button>
        </td>
    `;
    tbody.prepend(tr);
    tr.querySelector(".nome").focus();
}

function salvarFornecedor(btn) {
    const tr = btn.closest("tr");
    const data = {
        nome: tr.querySelector(".nome").value,
        cnpj: tr.querySelector(".cnpj").value,
        telefone: tr.querySelector(".telefone").value,
        email: tr.querySelector(".email").value
    };
    fetch("{% url 'salvar_fornecedor_inline' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(r => {
        if (r.sucesso) location.reload();
        else alert("Erro: " + r.erro);
    });
}
</script>
{% endblock %}
